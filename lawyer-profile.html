<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lawyer Profile | Brief-Case</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            min-height: 100vh;
        }

        /* Header Styles */
        .top-bar { 
            background: linear-gradient(135deg, #3a3d4a 0%, #2c2f38 100%);
            padding: 12px 50px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .donate-btn { 
            background: linear-gradient(135deg, #7a1a31 0%, #5d1425 100%);
            color: white; 
            padding: 10px 25px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(122, 26, 49, 0.3);
        }
        .donate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(122, 26, 49, 0.4);
        }
        .logo-section { 
            display: flex; 
            align-items: center; 
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .logo-section:hover {
            opacity: 0.85;
            transform: scale(1.02);
        }
        .logo { 
            font-size: 40px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        .brand-text h1 { 
            color: white; 
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .brand-text p { 
            color: #b0b0b0; 
            font-size: 12px;
            font-style: italic;
        }
        .top-right { 
            display: flex; 
            align-items: center; 
            gap: 20px;
        }
        .search-box { 
            background: white; 
            padding: 8px 15px; 
            border-radius: 20px; 
            display: flex; 
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .search-box input { 
            border: none; 
            outline: none; 
            width: 150px;
        }

        /* Sub Header */
        .sub-header { 
            background: white;
            padding: 18px 50px; 
            display: flex; 
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .back-section { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 20px; 
            font-weight: 600; 
            color: #2c2c2c;
        }
        .back-arrow { 
            font-size: 28px; 
            cursor: pointer;
            color: #7a1a31;
            transition: all 0.3s;
        }
        .back-arrow:hover {
            transform: translateX(-5px);
        }
        .profile-icon { 
            width: 45px; 
            height: 45px; 
            background: linear-gradient(135deg, #7a1a31 0%, #5d1425 100%);
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            cursor: pointer; 
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(122, 26, 49, 0.3);
            transition: all 0.3s ease;
        }
        .profile-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(122, 26, 49, 0.4);
        }
        .profile-icon img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover;
        }

        /* Profile Container */
        .profile-container { 
            padding: 50px; 
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Profile Header */
        .profile-header { 
            display: grid; 
            grid-template-columns: 280px 1fr auto; 
            gap: 40px; 
            margin-bottom: 40px;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .profile-header:hover {
            border-color: #7a1a31;
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.18);
        }
        .profile-image { 
            width: 280px; 
            height: 360px; 
            border-radius: 20px; 
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 5px solid #f5f5f5;
            transition: all 0.3s ease;
        }
        .profile-image:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        .profile-image img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover;
        }
        .profile-info h2 { 
            font-size: 36px; 
            color: #2c2c2c; 
            margin-bottom: 10px;
            font-weight: 700;
        }
        .profile-email { 
            color: #666; 
            font-size: 16px; 
            margin-bottom: 30px;
        }
        .info-boxes { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px;
        }
        .info-box { 
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 2px solid #f0f0f0;
            transition: all 0.3s ease;
        }
        .info-box:hover {
            border-color: #7a1a31;
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        .info-box h4 { 
            color: #7a1a31; 
            font-size: 15px; 
            font-weight: 700;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .info-box p { 
            color: #555; 
            line-height: 1.6;
            font-size: 15px;
        }

        /* Action Buttons */
        .action-buttons { 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
        }
        .btn-book { 
            background: linear-gradient(135deg, #7a1a31 0%, #5d1425 100%);
            color: white; 
            padding: 16px 40px; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 6px 16px rgba(122, 26, 49, 0.3);
        }
        .btn-book:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(122, 26, 49, 0.4);
        }
        .btn-message { 
            background: white;
            color: #7a1a31; 
            padding: 16px 40px; 
            border: 3px solid #7a1a31;
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 700;
            transition: all 0.3s ease;
        }
        .btn-message:hover {
            background: #7a1a31;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(122, 26, 49, 0.3);
        }
        .btn-rate { 
            background: linear-gradient(135deg, #ffd700 0%, #f0c000 100%);
            color: #333; 
            padding: 16px 40px; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 6px 16px rgba(255, 215, 0, 0.3);
        }
        .btn-rate:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
        }

        /* Section Cards */
        .biography-section, .section-card, .reviews-section { 
            background: white;
            padding: 40px; 
            border-radius: 20px; 
            margin-bottom: 30px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .biography-section:hover, .section-card:hover, .reviews-section:hover {
            border-color: #7a1a31;
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.18);
        }
        .biography-section h3, .section-card h3, .reviews-section h3 { 
            color: #2c2c2c; 
            font-size: 26px; 
            margin-bottom: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .biography-section h3::before, .section-card h3::before, .reviews-section h3::before {
            content: '';
            width: 5px;
            height: 28px;
            background: linear-gradient(135deg, #7a1a31 0%, #5d1425 100%);
            border-radius: 3px;
        }
        .biography-section p { 
            color: #555; 
            line-height: 1.9;
            font-size: 16px;
        }
        .bottom-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 30px;
        }
        .detail-item { 
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            border-radius: 12px;
            border: 2px solid #f0f0f0;
            transition: all 0.3s ease;
        }
        .detail-item:hover {
            border-color: #7a1a31;
            transform: translateX(5px);
        }
        .detail-item h4 { 
            color: #7a1a31; 
            font-size: 15px; 
            font-weight: 700;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .detail-item p { 
            color: #555; 
            font-size: 16px;
        }
        .rating-stars { 
            color: #ffd700; 
            font-size: 28px; 
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Reviews Section */
        .review-item { 
            border-bottom: 2px solid #f0f0f0;
            padding: 25px 0;
            transition: all 0.3s ease;
        }
        .review-item:hover {
            transform: translateX(10px);
            padding-left: 10px;
            border-left: 4px solid #7a1a31;
        }
        .review-item:last-child { 
            border-bottom: none;
        }
        .review-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px;
        }
        .review-author { 
            font-weight: 700;
            font-size: 17px; 
            color: #2c2c2c;
        }
        .review-date { 
            font-size: 13px; 
            color: #999;
        }
        .review-stars { 
            color: #ffd700; 
            font-size: 20px; 
            margin-bottom: 10px;
        }
        .review-text { 
            color: #555; 
            line-height: 1.7;
            font-size: 15px;
        }

        /* Modal Styles */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000; 
            justify-content: center; 
            align-items: center;
        }
        .modal.show { display: flex; }
        .modal-content { 
            background: white;
            padding: 50px; 
            border-radius: 20px; 
            max-width: 600px; 
            width: 90%; 
            box-shadow: 0 15px 50px rgba(0,0,0,0.4);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px;
        }
        .modal-header h3 { 
            font-size: 28px; 
            color: #2c2c2c;
            font-weight: 700;
        }
        .modal-close { 
            background: none;
            border: none; 
            font-size: 36px; 
            cursor: pointer; 
            color: #999;
            transition: all 0.3s;
        }
        .modal-close:hover { 
            color: #333;
            transform: rotate(90deg);
        }
        .star-rating { 
            display: flex; 
            gap: 15px; 
            justify-content: center; 
            margin: 40px 0;
        }
        .star { 
            font-size: 56px; 
            cursor: pointer; 
            color: #ddd; 
            transition: all 0.2s;
        }
        .star.active, .star:hover { 
            color: #ffd700;
            transform: scale(1.2);
        }
        .review-textarea { 
            width: 100%; 
            min-height: 140px; 
            padding: 18px; 
            border: 2px solid #e0e0e0;
            border-radius: 12px; 
            font-size: 15px; 
            font-family: inherit; 
            resize: vertical;
            transition: all 0.3s;
        }
        .review-textarea:focus {
            outline: none;
            border-color: #7a1a31;
            box-shadow: 0 0 0 3px rgba(122, 26, 49, 0.1);
        }
        .modal-buttons { 
            display: flex; 
            gap: 15px; 
            margin-top: 30px;
        }
        .btn-submit { 
            flex: 1; 
            background: linear-gradient(135deg, #7a1a31 0%, #5d1425 100%);
            color: white; 
            padding: 16px; 
            border: none; 
            border-radius: 10px; 
            font-size: 16px; 
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 16px rgba(122, 26, 49, 0.3);
        }
        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(122, 26, 49, 0.4);
        }
        .btn-cancel { 
            flex: 1; 
            background: #e0e0e0;
            color: #333; 
            padding: 16px; 
            border: none; 
            border-radius: 10px; 
            font-size: 16px; 
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-cancel:hover {
            background: #d0d0d0;
            transform: translateY(-3px);
        }

        /* Loading State */
        .loading { 
            text-align: center; 
            padding: 60px; 
            color: #666;
            font-size: 18px;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .profile-header { animation: fadeInUp 0.6s ease; }
        .biography-section { animation: fadeInUp 0.7s ease; }
        .bottom-grid { animation: fadeInUp 0.8s ease; }
        .reviews-section { animation: fadeInUp 0.9s ease; }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .profile-header {
                grid-template-columns: 1fr;
                text-align: center;
            }
            .profile-image {
                margin: 0 auto;
            }
            .action-buttons {
                flex-direction: row;
                justify-content: center;
            }
            .bottom-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <button class="donate-btn" onclick="goToDonate()"> Donate</button>
        <div class="logo-section" onclick="goToHome()">
           
            <div class="brand-text">
                <h1>brief-case</h1>
                <p>your case, our counsel</p>
            </div>
        </div>
        <div class="top-right">
            <div class="search-box">
                <span></span>
                <input type="text" placeholder="Search">
            </div>
            <span style="color:white;font-size:20px;cursor:pointer;"></span>
        </div>
    </div>

    <div class="sub-header">
        <div class="back-section">
            <span class="back-arrow" onclick="goBack()"></span>
            <span> Lawyer Profile</span>
        </div>
        <div class="profile-icon" onclick="goToProfile()"></div>
    </div>

    <div class="profile-container" id="profileContainer">
        <div class="loading"> Loading lawyer profile...</div>
    </div>

    <!-- Rating Modal -->
    <div class="modal" id="ratingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Rate This Lawyer</h3>
                <button class="modal-close" onclick="closeRatingModal()"></button>
            </div>
            <div class="star-rating" id="starRating">
                <span class="star" data-rating="1">★</span>
                <span class="star" data-rating="2">★</span>
                <span class="star" data-rating="3">★</span>
                <span class="star" data-rating="4">★</span>
                <span class="star" data-rating="5">★</span>
            </div>
            <textarea id="reviewText" class="review-textarea" placeholder="Share your experience (optional)"></textarea>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeRatingModal()">Cancel</button>
                <button class="btn-submit" onclick="submitRating()" id="submitBtn"> Submit Rating</button>
            </div>
        </div>
    </div>

    <script src="js/supabase-client.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/search.js"></script>
    <script src="js/messaging.js"></script>
    <script src="js/navigation.js"></script>
    <script>
        let currentLawyerId = null;
        let currentUser = null;
        let selectedRating = 0;
        let eligibleAppointment = null;

        async function init() {
            currentLawyerId = window.Navigation.getUrlParameter('id');
            
            console.log(' Initializing lawyer profile page');
            console.log(' Lawyer ID:', currentLawyerId);
            
            if (!currentLawyerId) {
                alert('Lawyer not found');
                goBack();
                return;
            }
            
            currentUser = await window.SupabaseClient.getCurrentUser();
            console.log(' Current user:', currentUser ? currentUser.id : 'Not logged in');
            
            const result = await window.Search.getLawyerDetails(currentLawyerId);
            
            if (!result.success || !result.data) {
                document.getElementById('profileContainer').innerHTML = 
                    '<div class="loading"> Lawyer not found</div>';
                return;
            }
            
            const lawyer = result.data;
            const reviews = await window.Search.getLawyerReviews(currentLawyerId);
            
            // Check if user can rate this lawyer
            let canRate = false;
            if (currentUser) {
                console.log(' Checking if user can rate lawyer...');
                const eligibility = await checkRatingEligibility(currentUser.id, currentLawyerId);
                canRate = eligibility.canRate;
                eligibleAppointment = eligibility.appointment;
                console.log(' Can rate?', canRate, 'Appointment:', eligibleAppointment?.id);
            } else {
                console.log(' User not logged in - cannot rate');
            }
            
            document.getElementById('profileContainer').innerHTML = `
                <div class="profile-header">
                    <div class="profile-image">
                        ${lawyer.users.profile_photo_url 
                            ? `<img src="${lawyer.users.profile_photo_url}" alt="${lawyer.users.first_name}">` 
                            : '<div style="width:100%;height:100%;background:linear-gradient(135deg, #e0e0e0 0%, #c0c0c0 100%);display:flex;align-items:center;justify-content:center;font-size:120px;"></div>'}
                    </div>

                    <div class="profile-info">
                        <h2> ${lawyer.users.first_name} ${lawyer.users.last_name}</h2>
                        <p class="profile-email"> ${lawyer.users.email}</p>

                        <div class="info-boxes">
                            <div class="info-box">
                                <h4> Specialization</h4>
                                <p>${lawyer.lawyer_practice_areas?.map(pa => pa.practice_areas.name).join(', ') || 'General Practice'}</p>
                            </div>
                            <div class="info-box">
                                <h4> Law Firm</h4>
                                <p>${lawyer.law_firm || 'Independent Practice'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-book" onclick="bookAppointment()"> Book Appointment</button>
                        <button class="btn-message" onclick="startMessage()"> Message</button>
                        ${canRate ? '<button class="btn-rate" onclick="openRatingModal()"> Rate Lawyer</button>' : ''}
                    </div>
                </div>

                <div class="biography-section">
                    <h3> Biography</h3>
                    <p>${lawyer.biography || 'Experienced legal professional committed to providing quality legal services.'}</p>
                </div>

                <div class="bottom-grid">
                    <div class="section-card">
                        <h3> Education & Qualifications</h3>
                        <p>${lawyer.education_qualifications || 'Licensed attorney with extensive legal training and experience.'}</p>
                    </div>

                    <div class="section-card">
                        <div class="detail-item">
                            <h4> Bar Registration</h4>
                            <p>${lawyer.bar_registration_no || 'Licensed'}</p>
                        </div>

                        <div class="detail-item">
                            <h4> Consultation Type</h4>
                            <p>${lawyer.consultation_type === 'both' ? ' In-Person & Online' : lawyer.consultation_type === 'online' ? ' Online Only' : ' In-Person Only'}</p>
                        </div>

                        <div class="detail-item">
                            <h4> Consultation Fee</h4>
                            <p>PKR ${lawyer.consultation_fee?.toLocaleString() || '5,000'}/hour</p>
                        </div>

                        <div class="detail-item">
                            <h4> Client Ratings</h4>
                            <div class="rating-stars">${''.repeat(Math.floor(lawyer.average_rating || 0))}</div>
                            <p>${lawyer.average_rating?.toFixed(1) || '0.0'}/5 (${lawyer.total_reviews || 0} reviews)</p>
                        </div>
                    </div>
                </div>

                ${reviews.success && reviews.data.length > 0 ? `
                <div class="reviews-section">
                    <h3> Client Reviews (${reviews.data.length})</h3>
                    ${reviews.data.map(review => `
                        <div class="review-item">
                            <div class="review-header">
                                <span class="review-author"> ${review.users?.first_name || 'Anonymous'}</span>
                                <span class="review-date"> ${new Date(review.created_at).toLocaleDateString()}</span>
                            </div>
                            <div class="review-stars">${'★'.repeat(review.rating)}</div>
                            ${review.review_text ? `<p class="review-text">${review.review_text}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            `;

            // Setup star rating interaction
            setupStarRating();
        }

        async function checkRatingEligibility(clientId, lawyerId) {
            try {
                console.log(' Checking rating eligibility for client:', clientId, 'lawyer:', lawyerId);
                
                // Check if user has ANY appointment with this lawyer (excluding cancelled)
                const { data: appointments, error } = await window.SupabaseClient.supabase
                    .from('appointments')
                    .select('id, status')
                    .eq('client_id', clientId)
                    .eq('lawyer_id', lawyerId)
                    .neq('status', 'cancelled');

                console.log(' Found appointments:', appointments);

                if (error) {
                    console.error(' Error fetching appointments:', error);
                    return { canRate: false, appointment: null };
                }

                if (!appointments || appointments.length === 0) {
                    console.log(' No appointments found');
                    return { canRate: false, appointment: null };
                }

                // Check if any of these appointments don't have a review yet
                for (const apt of appointments) {
                    const { data: existingReview } = await window.SupabaseClient.supabase
                        .from('reviews')
                        .select('id')
                        .eq('appointment_id', apt.id)
                        .maybeSingle();

                    console.log(' Checking appointment', apt.id, 'has review:', !!existingReview);

                    if (!existingReview) {
                        console.log(' Can rate! Found unrated appointment:', apt.id);
                        return { canRate: true, appointment: apt };
                    }
                }

                console.log(' All appointments already reviewed');
                return { canRate: false, appointment: null };
            } catch (error) {
                console.error(' Error checking rating eligibility:', error);
                return { canRate: false, appointment: null };
            }
        }

        function setupStarRating() {
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateStars();
                });

                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    stars.forEach((s, index) => {
                        if (index < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });

            document.getElementById('starRating').addEventListener('mouseleave', updateStars);
        }

        function updateStars() {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < selectedRating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function openRatingModal() {
            console.log(' Opening rating modal');
            console.log(' Eligible appointment:', eligibleAppointment);
            
            if (!eligibleAppointment) {
                alert(' You need to book an appointment with this lawyer before you can rate them.');
                return;
            }
            document.getElementById('ratingModal').classList.add('show');
            selectedRating = 0;
            updateStars();
            document.getElementById('reviewText').value = '';
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').classList.remove('show');
        }

        async function submitRating() {
            if (selectedRating === 0) {
                alert(' Please select a rating');
                return;
            }

            const reviewText = document.getElementById('reviewText').value.trim();
            const submitBtn = document.getElementById('submitBtn');
            
            submitBtn.disabled = true;
            submitBtn.textContent = ' Submitting...';

            const result = await window.Search.createReview({
                lawyerId: currentLawyerId,
                clientId: currentUser.id,
                appointmentId: eligibleAppointment.id,
                rating: selectedRating,
                reviewText: reviewText || null
            });

            if (result.success) {
                alert(' Thank you for your rating!');
                closeRatingModal();
                setTimeout(() => {
                    window.location.href = 'lawyer-profile.html?id=' + currentLawyerId + '&refresh=' + Date.now();
                }, 500);
            } else {
                alert(' Failed to submit rating: ' + result.error);
                submitBtn.disabled = false;
                submitBtn.textContent = ' Submit Rating';
            }
        }

        async function bookAppointment() {
            const user = await window.SupabaseClient.getCurrentUser();
            if (!user) {
                alert(' Please login to book an appointment');
                goToLogin();
                return;
            }
            
            window.location.href = `book-appointment.html?lawyerId=${currentLawyerId}`;
        }

        async function startMessage() {
            console.log('=== MESSAGE BUTTON CLICKED ===');
            
            const user = await window.SupabaseClient.getCurrentUser();
            console.log('Current user:', user);
            
            if (!user) {
                alert(' Please login to send messages');
                goToLogin();
                return;
            }
            
            if (!currentLawyerId) {
                alert(' Error: Lawyer ID not found');
                return;
            }
            
            if (!window.Messaging) {
                alert(' Error: Messaging system not loaded');
                return;
            }
            
            console.log('Creating conversation between', user.id, 'and', currentLawyerId);
            
            const result = await window.Messaging.getOrCreateConversation(user.id, currentLawyerId);
            console.log('Conversation result:', result);
            
            if (result.success) {
                console.log('Success! Redirecting to messages page...');
                window.location.href = `messages.html?conversation=${result.data.id}`;
            } else {
                console.error('Failed to create conversation:', result.error);
                alert(' Failed to start conversation: ' + result.error);
            }
        }

        init();
    </script>
</body>
</html>